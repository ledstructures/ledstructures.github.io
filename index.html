<!DOCTYPE html>
<html>
<link rel="stylesheet" href="IndexStyle.css">
<head> 
    <script src="winch.js"></script>
    <script src="webserial.js"></script>
    <style>
        td,
        tr,
        table {
            border: 1px solid black;
            border-collapse: collapse;
            text-align: left;
        }

        input,
        p {
            /* font-size: medium; */
            text-align: right;
            margin: 0;
        }
    </style>

</head>

<body>
    <table>
        <tr>
            <td>parameter</td>
            <td>new value</td>
            <td>current val</td>
        </tr>
        <tr>
            <td>Addresses:</td>
        </tr>
        <tr>
            <td>A address</td>
            <td> <input id="NewAddrA" type="number" min="1" max="512" />
            </td>
            <td>
                <p id="CurrAddrA"></p>
            </td>
        </tr>

        <tr>
            <td>B address</td>
            <td> <input id="NewAddrB" type="number" min="1" max="512" />
            </td>
            <td>
                <p id="CurrAddrB"></p>
            </td>
        </tr>

        <tr>
            <td>C address</td>
            <td> <input id="NewAddrC" type="number" min="1" max="512" />
            </td>
            <td>
                <p id="CurrAddrC"></p>
            </td>
        </tr>

        <tr>
            <td>D address</td>
            <td> <input id="NewAddrD" type="number" min="1" max="512" />
            </td>
            <td>
                <p id="CurrAddrD"></p>
            </td>
        </tr>

        <tr>
            <td>Safety address</td>
            <td> <input id="NewSaftyAddr" type="number" min="1" max="512" />
            </td>
            <td>
                <p id="CurrSaftyAddr"></p>
            </td>
        </tr>
        <tr>
            <td>Deviation:</td>
        </tr>

        <!-- <tr>
        <td>Winch A Deviation</td>
        <td> <input id="NewDevA" type="number" min="0" max="255" />
        </td>
        <td>
            <p id="CurrAddrA"></p>
        </td>
    </tr> -->

        <tr>
            <td>B max Deviation</td>
            <td> <input id="NewDevB" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrDevB"></p>
            </td>
        </tr>

        <tr>
            <td>C max Deviation</td>
            <td> <input id="NewDevC" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrDevC"></p>
            </td>
        </tr>

        <tr>
            <td>D max Deviation</td>
            <td> <input id="NewDevD" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrDevD"></p>
            </td>
        </tr>

        <tr>
            <td>Trim:</td>
        </tr>

        <tr>
            <td>Down</td>
            <td> <input id="NewDown" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrDown"></p>
            </td>
        </tr>

        <tr>
            <td>Up</td>
            <td> <input id="NewUp" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrUp"></p>
            </td>
        </tr>

        <tr>
            <td>Down2</td>
            <td> <input id="NewDownCD" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrDownCD"></p>
            </td>
        </tr>

        <tr>
            <td>Up2</td>
            <td> <input id="NewUpCD" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrUpCD"></p>
            </td>
        </tr>


        <tr>
            <td>Line position:</td>
        </tr>

        <!-- <tr>
        <td>Winch A Deviation</td>
        <td> <input id="NewDevA" type="number" min="0" max="255" />
        </td>
        <td>
            <p id="CurrAddrA"></p>
        </td>
    </tr> -->

        <tr>
            <td>B line position</td>
            <td> <input id="NewPosB" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrPosB"></p>
            </td>
        </tr>

        <tr>
            <td>C line position</td>
            <td> <input id="NewPosC" type="number" min="0" max="255" />
            </td>
            <td>
                <p id="CurrPosC"></p>
            </td>
        </tr>
        <tr>
            <td>mode</td>
            <td>
                <form id="NewMode">
                    <input type="radio" name="mode" id="NewModeOptionFolwA" checked="true">Square<br>
                    <input type="radio" name="mode" id="NewModeOptionFolwP">triangle<br>
                    <input type="radio" name="mode" id="NewModeOptionDubble">pair a&b, c&d<br>
                    <input type="radio" name="mode" id="NewModeOptionLine3">3 in line<br>
                    <input type="radio" name="mode" id="NewModeOptionLine4">4 in line<br>
                </form>
            </td>
            <td>
                <!-- display current mode -->
            </td>
        </tr>


        <tr>
            <td>type</td>
            <td>
                <form id="NewType">
                    <input type="radio" name="type" id="NewTypeorb5">orbi5<br>
                    <input type="radio" name="type" id="NewTypeorb9" checked="true">orbi9<br>
                    <input type="radio" name="type" id="NewTypeDLB">DLB<br>
                </form>
            </td>
            <td>
                <!-- display current type -->
            </td>
        </tr>
        <tr>
            <td>Name</td>
            <td>
                <input id="NewName" type="text" maxlength="8" />
            </td>
            <td>
                <p id="CurrName"></p>
            </td>
        </tr>
        <tr>
            <td>
                <input type="button" onclick="connect();" value="Connect" id="con">
                <!-- <input type="button" onclick="alert('Connect')" value="Connect"> -->
            </td>
            <td>
                <input type="button" onclick="alert('Send new values')" value="Send new values">
            </td>
            <td>
                <input type="button" onclick="alert('Get current values')" value="Get current values">
            </td>
        </tr>
        <tr>
            <td>
                <input type="button"
                    onclick="incrementAddresses(winchNew, getElementById('AddrIncrement').value, document.getElementById('AddrIncrementSafety').checked)"
                    value="Increment addresses">
            <td> <input id="AddrIncrement" type="number" min="1" max="512" />
            </td>
            <td>
                increment safety: <input type="checkbox" id="AddrIncrementSafety">
            </td>
        </tr>
    </table>
    <script type="text/javascript">
        // create serial obj from webserial wrapper
        const webserial = new WebSerialPort();

        // 'struct with all settings'
        const winchNew = new WinchSettings();
        // set default tosetting
        winchNew.SetDefaults();
        const winchCurr = new WinchSettings();

        // winchCurr.SetDefaults();

        // create a serial parser from winch send the instance to edit as arg
        const serialParser = new SerialWinchParser(winchCurr);

        // F onclick to connect to serial port(check on port connected evntlistener?) 
        function connect() {
            if (webserial) {
                if (document.getElementById("con").value == "Connect") {
                    webserial.openPort();
                    document.getElementById("con").value = "Disconnect"
                } else {
                    webserial.closePort();
                    document.getElementById("con").value = "Connect"
                }
            }
        }

        // copy the set data from the html to the winchNew obj
        function getNewData() {
            winchNew.WinchAaddr = document.getElementById("NewAddrA").value;
            winchNew.WinchBaddr = document.getElementById("NewAddrB").value;
            winchNew.WinchCaddr = document.getElementById("NewAddrC").value;
            winchNew.WinchDaddr = document.getElementById("NewAddrD").value;

            winchNew.WinchTrimUp = document.getElementById("NewUp").value;
            winchNew.WinchTrimDown = document.getElementById("NewDown").value;
            winchNew.WinchTrimUpCD = document.getElementById("NewUpCD").value;
            winchNew.WinchTrimDownCD = document.getElementById("NewDownCD").value;

            winchNew.WinchSafetyAddr = document.getElementById("NewSaftyAddr").value;

            // document.getElementById("NewDevA").innerHTML = winchNew.WinchAdev;
            winchNew.WinchBdev = document.getElementById("NewDevB").innerHTML;
            winchNew.WinchCdev = document.getElementById("NewDevC").innerHTML;
            winchNew.WinchDdev = document.getElementById("NewDevD").innerHTML;

            // document.getElementById("NewPosA").innerHTML = winchCurr.WinchALinP;
            winchNew.WinchBlinP = document.getElementById("NewPosB").innerHTML;
            winchNew.WinchClinP = document.getElementById("NewPosC").innerHTML;
        }

        // copy the data from the winchNew obj to the html
        function setNewData() {
            document.getElementById("NewAddrA").value = winchNew.WinchAaddr;
            document.getElementById("NewAddrB").value = winchNew.WinchBaddr;
            document.getElementById("NewAddrC").value = winchNew.WinchCaddr;
            document.getElementById("NewAddrD").value = winchNew.WinchDaddr;

            document.getElementById("NewUp").value = winchNew.WinchTrimUp;
            document.getElementById("NewDown").value = winchNew.WinchTrimDown;
            document.getElementById("NewUpCD").value = winchNew.WinchTrimUpCD;
            document.getElementById("NewDownCD").value = winchNew.WinchTrimDownCD;

            document.getElementById("NewSaftyAddr").value = winchNew.WinchSafetyAddr;

            document.getElementById("NewDevB").value = winchNew.WinchBdev;
            document.getElementById("NewDevC").value = winchNew.WinchCdev;
            document.getElementById("NewDevD").value = winchNew.WinchDdev;

            document.getElementById("NewPosB").value = winchNew.WinchBlinP;
            document.getElementById("NewPosC").value = winchNew.WinchClinP;

            document.getElementById("AddrIncrement").value = 40
        }

        // cpy the data from the 'winchCurr' obj to the html 
        function setCurrentData() {
            // winchCurr.WinchAaddr++;
            if (winchCurr.WinchAaddr)
                document.getElementById("CurrAddrA").innerHTML = winchCurr.WinchAaddr;
            if (winchCurr.WinchBaddr)
                document.getElementById("CurrAddrB").innerHTML = winchCurr.WinchBaddr;
            if (winchCurr.WinchCaddr)
                document.getElementById("CurrAddrC").innerHTML = winchCurr.WinchCaddr;
            if (winchCurr.WinchDaddr)
                document.getElementById("CurrAddrD").innerHTML = winchCurr.WinchDaddr;
            if (winchCurr.WinchTrimUp)
                document.getElementById("CurrUp").value = winchCurr.WinchTrimUp;
            if (winchCurr.WinchTrimDown)
                document.getElementById("CurrDown").value = winchCurr.WinchTrimDown;
            if (winchCurr.WinchTrimUpCD)
                document.getElementById("CurrUpCD").value = winchCurr.WinchTrimUpCD;
            if (winchCurr.WinchTrimDownCD)
                document.getElementById("CurrDownCD").value = winchCurr.WinchTrimDownCD;

            if (winchCurr.WinchSafetyAddr)
                document.getElementById("CurrSaftyAddr").innerHTML = winchCurr.WinchSafetyAddr;

            if (winchCurr.WinchBdev)
                document.getElementById("CurrDevB").innerHTML = winchCurr.WinchBdev;
            if (winchCurr.WinchCdev)
                document.getElementById("CurrDevC").innerHTML = winchCurr.WinchCdev;
            if (winchCurr.WinchDdev)
                document.getElementById("CurrDevD").innerHTML = winchCurr.WinchDdev;

            if (winchCurr.WinchBlinP)
                document.getElementById("CurrPosB").innerHTML = winchCurr.WinchBlinP;
            if (winchCurr.WinchClinP)
                document.getElementById("CurrPosC").innerHTML = winchCurr.WinchClinP;

        }

        // increases the addesses of WinchSettings Obj, 
        // takes WinchSettings obj, number to increment, bool to increment safety also
        function incrementAddresses(w, increment, saf) {
            let incr = parseInt(increment);
            if (!incr) {
                return
            }
            // mask to overflow at 512
            w.WinchAaddr = 0x01ff & (w.WinchAaddr + incr);
            w.WinchBaddr = 0x01ff & (w.WinchBaddr + incr);
            w.WinchCaddr = 0x01ff & (w.WinchCaddr + incr);
            w.WinchDaddr = 0x01ff & (w.WinchDaddr + incr);
            if (saf) {
                w.WinchSafetyAddr = 0x01ff & (w.WinchSafetyAddr + incr);
            }
            setNewData();
            console.log(w.WinchAaddr)
        }

        //// pppffftttt!!!
        // note bind to instance!
        webserial.on("data", serialParser.parseData.bind(serialParser));        // make the self accesable?

        // attacht a callback at the end of data parsed to update the html
        serialParser.endcommandcb = setCurrentData;
        // attacht the 
        // serialParser.wc = winchCurr;
        setCurrentData();
        setNewData();


    </script>

</body>